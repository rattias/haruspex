# Tutorial: Hello World (Java) {#tutorial_hello_world_java}

<table>
<tr><td style="vertical-align: center;"> \image html images/info-32.png  ""<td style="vertical-align: center;"> This tutorial introduces to `Trace`, `Entity`, `Block`, `Tag`, `EventSink`. All source files shown in this tutorial are available in the Haruspex installation directory under java/examples. <br> The tutorial also assumes such directory is set as current directory.
</table>

Let's start instrumenting the very first program everybody writes:

 
 ```java
class HelloWorld {
  public static void main(String[] args) {
  	System.out.println("Hello world!");
  }
}
```  
  There isn't much to instrument, so let's just say we're interested in measuring the time taken by the `main` function:


 ```java
1 import haruspex.common.Tag;
2 import haruspex.producer.*;

3 class HelloWorld1 {
4   public static void main(String[] args) {
5     Entity en = new Trace.Builder().build().entity("main");
6     try (Block b = en.block(Tag.of(Tag.name("main")), Tag.of("foo", "bar"))) {
7       System.out.println("Hello world!");
      }
    }
  }

```  
 
 Line `1` and `2` import all the `haruspex` classes required to instrument a program. At line `4` `new Trace.Builder().build()` creates a `Trace` instance. The Trace instance represents a handle on the portion
 of the trace generated by this (and in this example only) process. 
 From the `entity("main")` invocation on the Trace creates an `Entity` instance whose name is <i>main</i> (Note that Entity names are mandatory). In this example the `Entity` instance could represent the thread of execution; as this is a single-threaded program, just one entity needs to be created. 
Line `5` starts a block for the entity. `Block` implements `AutoCloseable`, so the block can be
used in a try-with-resource construct. 

We can also observe that the block was associated with a couple of tags, 
passed as arguments to `block()`. Tags are key-value pairs that can be associated to any of the Haruspex model
elements. Two flavor of tags are supported: core and user-defined. 

Core tags are tags that the framework may
interpret in certain ways. for example, the `name` core tag can be used to associate a human-readable identifier
to an object, which will be shown by default in Haruspex viewers. Core tags can be created calling a static
method on the `Tag` class and passing the corresponding value. 

User-defined tags are tags that can be associated to model elements but have no particular interpretation by
the framework. these are created calling the `Tag.of()` method, passing key and value. Most producer API 
method allow to pass one of more tag to tag the corresponding objects.

<table>
<tr><td style="vertical-align: center;"> \image html images/info-32.png  ""<td style="vertical-align: center;"> 
User-defined tag keys must start with a letter or underscore, and continue with letter, digits or underscores.
</table>
 

The block is automatically closed at line `9`. 

We can now build and run the program:

```
$ javac -cp ../build/jar/haruspex-producer.jar:../third-party/*:. HelloWorld1.java
$ java  -cp ../build/jar/haruspex-producer.jar:../third-party/*:. HelloWorld1.java
```

which should produce an output similar to this:

```
{"t":[{"@TIME_UNIT":"NANOSECONDS","@CLOCK_DOMAIN":"default","@CLOCK_MAX_SKEW":0,"?":"T"}],"h":[0,1527781968853819,"GQwGA4HAYLA"]}
{"t":[{"!":"main","?":"E"}],"h":[1,1527781972921518,"GQwGA4HAYLA","GAwGA4HA4PA"]}
{"t":[{"!":"main","?":"B"},{"foo":"bar","?":"P"}],"h":[2,1527781974109716,"GQwGA4HAYLA","GAwGA4HA4PA","0"]}
Hello world!
{"t":[{"?":"b"},{"?":"P"}],"h":[3,1527781974415465,"GQwGA4HAYLA","GAwGA4HA4PA","0"]}
```

As we can see, the expected output of the program is mixed with some weird-looking JSON. This happens because the execution of the `build()`, `entity()`, `block()` and the implicit `close()` produced one event each. The event is delivered to a specific instance of a sink configured in the `Trace.Builder`; as we didn't configure any, the default instance, which produced a JSON encoding of the events on stderr, was used. At this point we don't need
to worry about the specific details of the generated output; suffice to say that it contains all the information
required to build a trace model for visualization or analysis.

Let's now configure  a more useful sink:

```java
import haruspex.common.Tag;
import haruspex.common.event.FileStorageSink;
import haruspex.producer.*;

class HelloWorld2 {
  public static void main(String[] args) {
    Entity en = new Trace.Builder().setSink(new FileStorageSink("/tmp/traces")).build().entity("main");
    try (Block b = en.block(Tag.of(Tag.name("main")), Tag.of("foo", "bar"))) {
      System.out.println("Hello world!");
    }
  }
}
```
In this version we're configuring a `FileStorageSink`. This sink stores each trace as a separate
file in a directory specified as argument during sink instantiation (in this case `/tmp/traces/`). We can build
and run the program, and verify a trace has been created:

```
$ javac -cp ../build/jar/haruspex-producer.jar:../third-party/*:. HelloWorld2.java
$ java  -cp ../build/jar/haruspex-producer.jar:../third-party/*:. HelloWorld2.java
Hello world!
$ ls /tmp/traces/
j7bp3C93iiQ
$ cat /tmp/traces/j7bp3C93iiQ 
{"t":[{"@TIME_UNIT":"NANOSECONDS","@CLOCK_DOMAIN":"default","@CLOCK_MAX_SKEW":0,"?":"T"}],"h":[0,1534547976998761,"j7bp3C93iiQ"]}
{"t":[{"!":"main","?":"E"}],"h":[1,1534547981986172,"j7bp3C93iiQ","4BqvBJZi8eI"]}
{"t":[{"!":"main","?":"B"},{"foo":"bar","?":"P"}],"h":[2,1534547982997496,"j7bp3C93iiQ","4BqvBJZi8eI","0"]}
{"t":[{"?":"b"},{"?":"P"}],"h":[3,1534547983314731,"j7bp3C93iiQ","4BqvBJZi8eI","0"]}

```

The trace name corresponds to the trace ID, a 64-bit random number, Base64-encoded and with '/' replaced by '_'.

 